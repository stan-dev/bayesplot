<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Graphical posterior predictive checks using the bayesplot package • bayesplot</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Graphical posterior predictive checks using the bayesplot package">
<meta property="og:description" content="bayesplot">
<meta property="og:image" content="https://mc-stan.org/bayesplot/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bayesplot</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://mc-stan.org/rstan">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr">cmdstanr</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="https://mc-stan.org/shinystan">shinystan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/loo">loo</a>
    </li>
    <li>
      <a href="https://mc-stan.org/projpred">projpred</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstantools">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://mc-stan.org">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/bayesplot">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://discourse.mc-stan.org/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="graphical-ppcs_files/header-attrs-2.3/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Graphical posterior predictive checks using the bayesplot package</h1>
                        <h4 class="author">Jonah Gabry</h4>
            
            <h4 class="date">Latest version: 2021-01-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/bayesplot/blob/master/vignettes/graphical-ppcs.Rmd"><code>vignettes/graphical-ppcs.Rmd</code></a></small>
      <div class="hidden name"><code>graphical-ppcs.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This vignette focuses on graphical posterior predictive checks (PPC). Plots of parameter estimates from MCMC draws are covered in the separate vignette <a href="https://mc-stan.org/bayesplot/articles/plotting-mcmc-draws.html"><em>Plotting MCMC draws</em></a>, and MCMC diagnostics are covered in the <a href="https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html"><em>Visual MCMC diagnostics</em></a> vignette.</p>
<div id="graphical-posterior-predictive-checks-ppcs" class="section level3">
<h3 class="hasAnchor">
<a href="#graphical-posterior-predictive-checks-ppcs" class="anchor"></a>Graphical posterior predictive checks (PPCs)</h3>
<p>The <strong>bayesplot</strong> package provides various plotting functions for <em>graphical posterior predictive checking</em>, that is, creating graphical displays comparing observed data to simulated data from the posterior predictive distribution (<a href="#gabry2019">Gabry et al, 2019</a>).</p>
<p>The idea behind posterior predictive checking is simple: if a model is a good fit then we should be able to use it to generate data that looks a lot like the data we observed. To generate the data used for posterior predictive checks (PPCs) we simulate from the <em>posterior predictive distribution</em>. This is the distribution of the outcome variable implied by a model after using the observed data <span class="math inline">\(y\)</span> (a vector of <span class="math inline">\(N\)</span> outcome values) to update our beliefs about unknown model parameters <span class="math inline">\(\theta\)</span>. The posterior predictive distribution for observation <span class="math inline">\(\widetilde{y}\)</span> can be written as <span class="math display">\[p(\widetilde{y} \,|\, y) = \int
p(\widetilde{y} \,|\, \theta) \, p(\theta \,|\, y) \, d\theta.\]</span> Typically we will also condition on <span class="math inline">\(X\)</span> (a matrix of predictor variables).</p>
<p>For each draw (simulation) <span class="math inline">\(s = 1, \ldots, S\)</span> of the parameters from the posterior distribution, <span class="math inline">\(\theta^{(s)} \sim p(\theta \,|\, y)\)</span>, we draw an entire vector of <span class="math inline">\(N\)</span> outcomes <span class="math inline">\(\widetilde{y}^{(s)}\)</span> from the posterior predictive distribution by simulating from the data model conditional on parameters <span class="math inline">\(\theta^{(s)}\)</span>. The result is an <span class="math inline">\(S \times N\)</span> matrix of draws <span class="math inline">\(\widetilde{y}\)</span>.</p>
<p>When simulating from the posterior predictive distribution we can use either the same values of the predictors <span class="math inline">\(X\)</span> that we used when fitting the model or new observations of those predictors. When we use the same values of <span class="math inline">\(X\)</span> we denote the resulting simulations by <span class="math inline">\(y^{rep}\)</span>, as they can be thought of as replications of the outcome <span class="math inline">\(y\)</span> rather than predictions for future observations (<span class="math inline">\(\widetilde{y}\)</span> using predictors <span class="math inline">\(\widetilde{X}\)</span>). This corresponds to the notation from Gelman et al. (2013) and is the notation used throughout the package documentation.</p>
<p>Using the replicated datasets drawn from the posterior predictive distribution, the functions in the <strong>bayesplot</strong> package create various graphical displays comparing the observed data <span class="math inline">\(y\)</span> to the replications. The names of the <strong>bayesplot</strong> plotting functions for posterior predictive checking all have the prefix <code>ppc_</code>.</p>
</div>
<div id="setup" class="section level3">
<h3 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h3>
<p>In addition to <strong>bayesplot</strong> we’ll load the following packages:</p>
<ul>
<li>
<strong>ggplot2</strong>, in case we want to customize the ggplot objects created by <strong>bayesplot</strong>
</li>
<li>
<strong>rstanarm</strong>, for fitting the example models used throughout the vignette</li>
</ul>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"bayesplot"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ggplot2"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"rstanarm"</span>)</pre></body></html></div>
</div>
<div id="example-models" class="section level3">
<h3 class="hasAnchor">
<a href="#example-models" class="anchor"></a>Example models</h3>
<p>To demonstrate some of the various PPCs that can be created with the <strong>bayesplot</strong> package we’ll use an example of comparing Poisson and Negative binomial regression models from one of the <strong>rstanarm</strong> <a href="https://mc-stan.org/rstanarm/articles/count.html">package vignettes</a> (Gabry and Goodrich, 2017).</p>
<blockquote>
<p>We want to make inferences about the efficacy of a certain pest management system at reducing the number of roaches in urban apartments. […] The regression predictors for the model are the pre-treatment number of roaches <code>roach1</code>, the treatment indicator <code>treatment</code>, and a variable <code>senior</code> indicating whether the apartment is in a building restricted to elderly residents. Because the number of days for which the roach traps were used is not the same for all apartments in the sample, we include it as an exposure […].</p>
</blockquote>
<p>First we fit a Poisson regression model with outcome variable <code>y</code> representing the roach count in each apartment at the end of the experiment.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">roaches</span>) <span class="co"># see help("rstanarm-datasets")</span></pre></body></html></div>
<pre><code>    y roach1 treatment senior exposure2
1 153 308.00         1      0  0.800000
2 127 331.25         1      0  0.600000
3   7   1.67         1      0  1.000000
4   7   3.00         1      0  1.000000
5   0   2.00         1      0  1.142857
6   0   0.00         1      0  1.000000</code></pre>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">roaches</span>$<span class="no">roach100</span> <span class="kw">&lt;-</span> <span class="no">roaches</span>$<span class="no">roach1</span> / <span class="fl">100</span> <span class="co"># pre-treatment number of roaches (in 100s)</span></pre></body></html></div>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># using rstanarm's default priors. For details see the section on default</span>
<span class="co"># weakly informative priors at https://mc-stan.org/rstanarm/articles/priors.html</span>
<span class="no">fit_poisson</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/stan_glm.html">stan_glm</a></span>(
  <span class="no">y</span> ~ <span class="no">roach100</span> + <span class="no">treatment</span> + <span class="no">senior</span>,
  <span class="kw">offset</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">exposure2</span>),
  <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span>(<span class="kw">link</span> <span class="kw">=</span> <span class="st">"log"</span>),
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">roaches</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="fl">1111</span>,
  <span class="kw">refresh</span> <span class="kw">=</span> <span class="fl">0</span> <span class="co"># suppresses all output as of v2.18.1 of rstan</span>
)</pre></body></html></div>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">fit_poisson</span>)</pre></body></html></div>
<pre><code>stan_glm
 family:       poisson [log]
 formula:      y ~ roach100 + treatment + senior
 observations: 262
 predictors:   4
------
            Median MAD_SD
(Intercept)  3.1    0.0  
roach100     0.7    0.0  
treatment   -0.5    0.0  
senior      -0.4    0.0  

------
* For help interpreting the printed output see ?print.stanreg
* For info on the priors used see ?prior_summary.stanreg</code></pre>
<p>We’ll also fit the negative binomial model that we’ll compare to the Poisson:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">fit_nb</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="no">fit_poisson</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"neg_binomial_2"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">fit_nb</span>)</pre></body></html></div>
<pre><code>stan_glm
 family:       neg_binomial_2 [log]
 formula:      y ~ roach100 + treatment + senior
 observations: 262
 predictors:   4
------
            Median MAD_SD
(Intercept)  2.8    0.2  
roach100     1.3    0.3  
treatment   -0.8    0.2  
senior      -0.3    0.3  

Auxiliary parameter(s):
                      Median MAD_SD
reciprocal_dispersion 0.3    0.0   

------
* For help interpreting the printed output see ?print.stanreg
* For info on the priors used see ?prior_summary.stanreg</code></pre>
</div>
<div id="defining-y-and-yrep" class="section level3">
<h3 class="hasAnchor">
<a href="#defining-y-and-yrep" class="anchor"></a>Defining <code>y</code> and <code>yrep</code>
</h3>
<p>In order to use the PPC functions from the <strong>bayesplot</strong> package we need a vector <code>y</code> of outcome values,</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">roaches</span>$<span class="no">y</span></pre></body></html></div>
<p>and a matrix <code>yrep</code> of draws from the posterior predictive distribution,</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">yrep_poisson</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/posterior_predict.stanreg.html">posterior_predict</a></span>(<span class="no">fit_poisson</span>, <span class="kw">draws</span> <span class="kw">=</span> <span class="fl">500</span>)
<span class="no">yrep_nb</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/posterior_predict.stanreg.html">posterior_predict</a></span>(<span class="no">fit_nb</span>, <span class="kw">draws</span> <span class="kw">=</span> <span class="fl">500</span>)
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">yrep_poisson</span>)</pre></body></html></div>
<pre><code>[1] 500 262</code></pre>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">yrep_nb</span>)</pre></body></html></div>
<pre><code>[1] 500 262</code></pre>
<p>Each row of the matrix is a draw from the posterior predictive distribution, i.e. a vector with one element for each of the data points in <code>y</code>.</p>
<p>Since we fit the models using <strong>rstanarm</strong> we used its special <code>posterior_predict</code> function, but if we were using a model fit with the <strong>rstan</strong> package we could create <code>yrep</code> in the <code>generated quantities</code> block of the Stan program or by doing simulations in R after fitting the model. Draws from the posterior predictive distribution can be used with <strong>bayesplot</strong> regardless of whether or not the model was fit using an interface to Stan. <strong>bayesplot</strong> just requires a <code>yrep</code> matrix that has <code>number_of_draws</code> rows and <code>number_of_observations</code> columns.</p>
<p><br></p>
</div>
</div>
<div id="histograms-and-density-estimates" class="section level2">
<h2 class="hasAnchor">
<a href="#histograms-and-density-estimates" class="anchor"></a>Histograms and density estimates</h2>
<div id="ppc_dens_overlay" class="section level4">
<h4 class="hasAnchor">
<a href="#ppc_dens_overlay" class="anchor"></a>ppc_dens_overlay</h4>
<p>The first PPC we’ll look at is a comparison of the distribution of <code>y</code> and the distributions of some of the simulated datasets (rows) in the <code>yrep</code> matrix.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="../reference/bayesplot-colors.html">color_scheme_set</a></span>(<span class="st">"brightblue"</span>)
<span class="fu"><a href="../reference/PPC-distributions.html">ppc_dens_overlay</a></span>(<span class="no">y</span>, <span class="no">yrep_poisson</span>[<span class="fl">1</span>:<span class="fl">50</span>, ])</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_dens_overlay-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>In the plot above, the dark line is the distribution of the observed outcomes <code>y</code> and each of the 50 lighter lines is the kernel density estimate of one of the replications of <code>y</code> from the posterior predictive distribution (i.e., one of the rows in <code>yrep</code>). This plot makes it easy to see that this model fails to account for the large proportion of zeros in <code>y</code>. That is, the model predicts fewer zeros than were actually observed.</p>
<p>To see the discrepancy at the lower values of more clearly we can use the <code>xlim</code> function from <strong>ggplot2</strong> to restrict the range of the x-axis:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="../reference/PPC-distributions.html">ppc_dens_overlay</a></span>(<span class="no">y</span>, <span class="no">yrep_poisson</span>[<span class="fl">1</span>:<span class="fl">50</span>, ]) + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span>(<span class="fl">0</span>, <span class="fl">150</span>)</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_dens_overlay-2-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>See Figure 6 in <a href="#gabry2019">Gabry et al. (2019)</a> for another example of using <code>ppc_dens_overlay</code>.</p>
</div>
<div id="ppc_hist" class="section level4">
<h4 class="hasAnchor">
<a href="#ppc_hist" class="anchor"></a>ppc_hist</h4>
<p>We could see the same thing from a different perspective by looking at separate histograms of <code>y</code> and some of the <code>yrep</code> datasets using the <code>ppc_hist</code> function:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="../reference/PPC-distributions.html">ppc_hist</a></span>(<span class="no">y</span>, <span class="no">yrep_poisson</span>[<span class="fl">1</span>:<span class="fl">5</span>, ])</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_hist-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The same plot for the negative binomial model looks much different:</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="fu"><a href="../reference/PPC-distributions.html">ppc_hist</a></span>(<span class="no">y</span>, <span class="no">yrep_nb</span>[<span class="fl">1</span>:<span class="fl">5</span>, ])</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_hist-nb-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The negative binomial model does better handling the number of zeros in the data, but it occasionally predicts values that are way too large, which is why the x-axes extend to such high values in the plot and make it difficult to read. To see the predictions for the smaller values more clearly we can zoom in:</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="fu"><a href="../reference/PPC-distributions.html">ppc_hist</a></span>(<span class="no">y</span>, <span class="no">yrep_nb</span>[<span class="fl">1</span>:<span class="fl">5</span>, ], <span class="kw">binwidth</span> <span class="kw">=</span> <span class="fl">20</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(<span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">1</span>, <span class="fl">300</span>))</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_hist-nb-2-1.png" width="60%" style="display: block; margin: auto;"></p>
<p><br></p>
</div>
</div>
<div id="distributions-of-test-statistics" class="section level2">
<h2 class="hasAnchor">
<a href="#distributions-of-test-statistics" class="anchor"></a>Distributions of test statistics</h2>
<p>Another way to see that the Poisson model predicts too few zeros is to look at the distribution of the proportion of zeros over the replicated datasets from the posterior predictive distribution in <code>yrep</code> and compare to the proportion of observed zeros in <code>y</code>.</p>
<div id="ppc_stat" class="section level4">
<h4 class="hasAnchor">
<a href="#ppc_stat" class="anchor"></a>ppc_stat</h4>
<p>First we define a function that takes a vector as input and returns the proportion of zeros:</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">prop_zero</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span> <span class="kw">==</span> <span class="fl">0</span>)
<span class="fu">prop_zero</span>(<span class="no">y</span>) <span class="co"># check proportion of zeros in y</span></pre></body></html></div>
<pre><code>[1] 0.3587786</code></pre>
<p>The <code>stat</code> argument to <code>ppc_stat</code> accepts a function or the name of a function for computing a test statistic from a vector of data. In our case we can specify <code>stat = "prop_zero"</code> since we’ve already defined the <code>prop_zero</code> function, but we also could have used <code>stat = function(x) mean(x == 0)</code>.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="../reference/PPC-test-statistics.html">ppc_stat</a></span>(<span class="no">y</span>, <span class="no">yrep_poisson</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"prop_zero"</span>, <span class="kw">binwidth</span> <span class="kw">=</span> <span class="fl">0.005</span>)</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_stat-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The dark line is at the value <span class="math inline">\(T(y)\)</span>, i.e. the value of the test statistic computed from the observed <span class="math inline">\(y\)</span>, in this case <code>prop_zero(y)</code>. The lighter area on the left is actually a histogram of the proportion of zeros in in the <code>yrep</code> simulations, but it can be hard to see because almost none of the simulated datasets in <code>yrep</code> have any zeros.</p>
<p>Here’s the same plot for the negative binomial model:</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="fu"><a href="../reference/PPC-test-statistics.html">ppc_stat</a></span>(<span class="no">y</span>, <span class="no">yrep_nb</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"prop_zero"</span>)</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_stat-nb-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Again we see that the negative binomial model does a much better job predicting the proportion of observed zeros than the Poisson.</p>
<p>However, if we look instead at the distribution of the maximum value in the replications, we can see that the Poisson model makes more realistic predictions than the negative binomial:</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="fu"><a href="../reference/PPC-test-statistics.html">ppc_stat</a></span>(<span class="no">y</span>, <span class="no">yrep_poisson</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"max"</span>)</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_stat-max-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="fu"><a href="../reference/PPC-test-statistics.html">ppc_stat</a></span>(<span class="no">y</span>, <span class="no">yrep_nb</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"max"</span>)</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_stat-max-2.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu"><a href="../reference/PPC-test-statistics.html">ppc_stat</a></span>(<span class="no">y</span>, <span class="no">yrep_nb</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"max"</span>, <span class="kw">binwidth</span> <span class="kw">=</span> <span class="fl">100</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(<span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">1</span>, <span class="fl">5000</span>))</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_stat-max-3.png" width="60%" style="display: block; margin: auto;"></p>
<p>See Figure 7 in <a href="#gabry2019">Gabry et al. (2019)</a> for another example of using <code>ppc_stat</code>.</p>
<p><br></p>
</div>
</div>
<div id="other-ppcs-and-ppcs-by-group" class="section level2">
<h2 class="hasAnchor">
<a href="#other-ppcs-and-ppcs-by-group" class="anchor"></a>Other PPCs and PPCs by group</h2>
<p>There are many additional PPCs available, including plots of predictive intervals, distributions of predictive errors, and more. For links to the documentation for all of the various PPC plots see <code><a href="../reference/PPC-overview.html">help("PPC-overview")</a></code> from R or the <a href="https://mc-stan.org/bayesplot/reference/index.html#section-ppc">online documentation</a> on the Stan website.</p>
<p>The <code>available_ppc</code> function can also be used to list the names of all PPC plotting functions:</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="fu"><a href="../reference/available_ppc.html">available_ppc</a></span>()</pre></body></html></div>
<pre><code>bayesplot PPC module:
  ppc_bars
  ppc_bars_grouped
  ppc_boxplot
  ppc_data
  ppc_dens
  ppc_dens_overlay
  ppc_dens_overlay_grouped
  ppc_ecdf_overlay
  ppc_ecdf_overlay_grouped
  ppc_error_binned
  ppc_error_hist
  ppc_error_hist_grouped
  ppc_error_scatter
  ppc_error_scatter_avg
  ppc_error_scatter_avg_vs_x
  ppc_freqpoly
  ppc_freqpoly_grouped
  ppc_hist
  ppc_intervals
  ppc_intervals_data
  ppc_intervals_grouped
  ppc_km_overlay
  ppc_loo_intervals
  ppc_loo_pit
  ppc_loo_pit_data
  ppc_loo_pit_overlay
  ppc_loo_pit_qq
  ppc_loo_ribbon
  ppc_ribbon
  ppc_ribbon_data
  ppc_ribbon_grouped
  ppc_rootogram
  ppc_scatter
  ppc_scatter_avg
  ppc_scatter_avg_grouped
  ppc_stat
  ppc_stat_2d
  ppc_stat_freqpoly_grouped
  ppc_stat_grouped
  ppc_violin_grouped</code></pre>
<p>Many of the available PPCs can also be carried out within levels of a grouping variable. Any function for PPCs by group will have a name ending in <code>_grouped</code> and will accept an additional argument <code>group</code>. The full list of currently available <code>_grouped</code> functions is:</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="../reference/available_ppc.html">available_ppc</a></span>(<span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"_grouped"</span>)</pre></body></html></div>
<pre><code>bayesplot PPC module:
(matching pattern '_grouped') 
  ppc_bars_grouped
  ppc_dens_overlay_grouped
  ppc_ecdf_overlay_grouped
  ppc_error_hist_grouped
  ppc_freqpoly_grouped
  ppc_intervals_grouped
  ppc_ribbon_grouped
  ppc_scatter_avg_grouped
  ppc_stat_freqpoly_grouped
  ppc_stat_grouped
  ppc_violin_grouped</code></pre>
<div id="ppc_stat_grouped" class="section level4">
<h4 class="hasAnchor">
<a href="#ppc_stat_grouped" class="anchor"></a>ppc_stat_grouped</h4>
<p>For example, <code>ppc_stat_grouped</code> is the same as <code>ppc_stat</code> except that the test statistic is computed within levels of the grouping variable and a separate plot is made for each level:</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="fu"><a href="../reference/PPC-test-statistics.html">ppc_stat_grouped</a></span>(<span class="no">y</span>, <span class="no">yrep_nb</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">roaches</span>$<span class="no">treatment</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"prop_zero"</span>)</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/ppc_stat_grouped-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>See Figure 8 in <a href="#gabry2019">Gabry et al. (2019)</a> for another example of using <code>ppc_stat_grouped</code>.</p>
<p><br></p>
</div>
</div>
<div id="providing-an-interface-to-bayesplot-ppcs-from-another-package" class="section level2">
<h2 class="hasAnchor">
<a href="#providing-an-interface-to-bayesplot-ppcs-from-another-package" class="anchor"></a>Providing an interface to bayesplot PPCs from another package</h2>
<p>The <strong>bayesplot</strong> package provides the S3 generic function <code>pp_check</code>. Authors of R packages for Bayesian inference are encouraged to define methods for the fitted model objects created by their packages. This will hopefully be convenient for both users and developers and contribute to the use of the same naming conventions across many of the R packages for Bayesian data analysis.</p>
<p>To provide an interface to <strong>bayesplot</strong> from your package, you can very easily define a <code>pp_check</code> method (or multiple <code>pp_check</code> methods) for the fitted model objects created by your package. All a <code>pp_check</code> method needs to do is provide the <code>y</code> vector and <code>yrep</code> matrix arguments to the various plotting functions included in <strong>bayesplot</strong>.</p>
<div id="defining-a-pp_check-method" class="section level3">
<h3 class="hasAnchor">
<a href="#defining-a-pp_check-method" class="anchor"></a>Defining a <code>pp_check</code> method</h3>
<p>Here is an example for how to define a simple <code>pp_check</code> method in a package that creates fitted model objects of class <code>"foo"</code>. We will define a method <code>pp_check.foo</code> that extracts the data <code>y</code> and the draws from the posterior predictive distribution <code>yrep</code> from an object of class <code>"foo"</code> and then calls one of the plotting functions from <strong>bayesplot</strong>.</p>
<p>Suppose that objects of class <code>"foo"</code> are lists with named components, two of which are <code>y</code> and <code>yrep</code>. Here’s a simple method <code>pp_check.foo</code> that offers the user the option of two different plots:</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="co"># @param object An object of class "foo".</span>
<span class="co"># @param type The type of plot.</span>
<span class="co"># @param ... Optional arguments passed on to the bayesplot plotting function.</span>
<span class="no">pp_check.foo</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">object</span>, <span class="no">type</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"multiple"</span>, <span class="st">"overlaid"</span>), <span class="no">...</span>) {
  <span class="no">type</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html">match.arg</a></span>(<span class="no">type</span>)
  <span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">object</span><span class="kw">[[</span><span class="st">"y"</span>]]
  <span class="no">yrep</span> <span class="kw">&lt;-</span> <span class="no">object</span><span class="kw">[[</span><span class="st">"yrep"</span>]]
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">yrep</span>) <span class="kw">&gt;=</span> <span class="fl">50</span>)
  <span class="no">samp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">yrep</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">type</span> <span class="kw">==</span> <span class="st">"overlaid"</span>, <span class="fl">50</span>, <span class="fl">5</span>))
  <span class="no">yrep</span> <span class="kw">&lt;-</span> <span class="no">yrep</span>[<span class="no">samp</span>, ]

  <span class="kw">if</span> (<span class="no">type</span> <span class="kw">==</span> <span class="st">"overlaid"</span>) {
    <span class="fu"><a href="../reference/PPC-distributions.html">ppc_dens_overlay</a></span>(<span class="no">y</span>, <span class="no">yrep</span>, <span class="no">...</span>)
  } <span class="kw">else</span> {
    <span class="fu"><a href="../reference/PPC-distributions.html">ppc_hist</a></span>(<span class="no">y</span>, <span class="no">yrep</span>, <span class="no">...</span>)
  }
}</pre></body></html></div>
<p>To try out <code>pp_check.foo</code> we can just make a list with <code>y</code> and <code>yrep</code> components and give it class <code>foo</code>:</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">200</span>), <span class="kw">yrep</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1e5</span>), <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">500</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">200</span>))
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">x</span>) <span class="kw">&lt;-</span> <span class="st">"foo"</span></pre></body></html></div>
<div class="sourceCode" id="cb35"><html><body><pre class="r"><span class="fu"><a href="../reference/bayesplot-colors.html">color_scheme_set</a></span>(<span class="st">"purple"</span>)
<span class="fu"><a href="../reference/pp_check.html">pp_check</a></span>(<span class="no">x</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"multiple"</span>, <span class="kw">binwidth</span> <span class="kw">=</span> <span class="fl">0.3</span>)</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/pp_check-1-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="fu"><a href="../reference/bayesplot-colors.html">color_scheme_set</a></span>(<span class="st">"darkgray"</span>)
<span class="fu"><a href="../reference/pp_check.html">pp_check</a></span>(<span class="no">x</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"overlaid"</span>)</pre></body></html></div>
<p><img src="graphical-ppcs_files/figure-html/pp_check-2-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div id="examples-of-pp_check-methods-in-other-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#examples-of-pp_check-methods-in-other-packages" class="anchor"></a>Examples of <code>pp_check</code> methods in other packages</h3>
<p>Several packages currently use this approach to provide an interface to <strong>bayesplot</strong>’s graphical posterior predictive checks. See, for example, the <code>pp_check</code> methods in the <a href="https://CRAN.R-project.org/package=rstanarm"><strong>rstanarm</strong></a> and <a href="https://CRAN.R-project.org/package=brms"><strong>brms</strong></a> packages.</p>
<p><br></p>
</div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Buerkner, P. (2017). brms: Bayesian Regression Models using Stan. R package version 1.7.0. <a href="https://CRAN.R-project.org/package=brms" class="uri">https://CRAN.R-project.org/package=brms</a></p>
<p>Gabry, J., and Goodrich, B. (2017). rstanarm: Bayesian Applied Regression Modeling via Stan. R package version 2.15.3. <a href="https://mc-stan.org/rstanarm/" class="uri">https://mc-stan.org/rstanarm/</a>, <a href="https://CRAN.R-project.org/package=rstanarm" class="uri">https://CRAN.R-project.org/package=rstanarm</a></p>
<p>Gabry, J. , Simpson, D. , Vehtari, A. , Betancourt, M. and Gelman, A. (2019), Visualization in Bayesian workflow. <em>J. R. Stat. Soc. A</em>, 182: 389-402. :10.1111/rssa.12378. (<a href="https://rss.onlinelibrary.wiley.com/doi/full/10.1111/rssa.12378">journal version</a>, <a href="https://arxiv.org/abs/1709.01449">arXiv preprint</a>, <a href="https://github.com/jgabry/bayes-vis-paper">code on GitHub</a>) <a id="gabry2019"></a></p>
<p>Gelman, A., Carlin, J. B., Stern, H. S., Dunson, D. B., Vehtari, A., and Rubin, D. B. (2013). <em>Bayesian Data Analysis</em>. Chapman &amp; Hall/CRC Press, London, third edition.</p>
<p>Stan Development Team. <em>Stan Modeling Language Users Guide and Reference Manual</em>. <a href="https://mc-stan.org/users/documentation/" class="uri">https://mc-stan.org/users/documentation/</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonah Gabry, Tristan Mahr.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '28ab84fbf0d3f58232875561b9a208cd',
    indexName: 'bayesplot',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
